---
title: "Poission Regression Model Project"
output: html_document
date: "2023-05-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(caret)
```

```{r}
data('ShipAccidents', package='AER')
ShipAccidents = subset(ShipAccidents, service > 0)
```

```{r}
ShipAccidents
hist(ShipAccidents$incidents)
```

```{r}
table(ShipAccidents$type, ShipAccidents$operation)
```

All variables in the full regression model (with log link function) are significant (not including `typeE`, but the rest of the types are significant, so we leave it in), but since the dataset is so small, it seems appropriate to not include `construction`.

```{r}
full_poisson = glm(incidents ~ ., data=ShipAccidents, family=poisson())
summary(full_poisson)
```

```{r}
poisson_no_constr = glm(incidents ~ .-construction, data=ShipAccidents, family=poisson())
summary(poisson_no_constr)
```

Residual plot looks good, but ship 9 has large leverage and high cook's distance, so it seems appropriate to exclude it.

```{r}
plot(poisson_no_constr)
```

```{r}
# had to supply starting values to get code to run
poisson_ident_no_constr = glm(incidents ~ .-construction,
                              data=ShipAccidents, family=poisson(link='identity'),
                              start = coef(poisson_no_constr))
summary(poisson_ident_no_constr)
```

Residual plot looks bad for identity link function. Some fitted values are *much* larger than others, and there is not a good spread in the plot. (Ship 9 is causing problems here as well.)

```{r}
plot(poisson_ident_no_constr)
```

The summary() function and tidy() function (from `broom`) both give information for performing inference on the coefficients for the regression model. Using the tidy() function lets us easily exponentiate the estimated coefficients for the model.

```{r}
## recommended model (log link)
## take out ship 9
poisson_no_constr_no9 = glm(incidents ~ .-construction,
                            data=ShipAccidents[rownames(ShipAccidents)!=9,],
                            family=poisson())
summary(poisson_no_constr_no9)
```

We can define coefficients $\beta_B, \beta_C, \beta_D, \beta_E, \beta_\text{75-79}, \beta_\text{service}$ to be the "true" coefficients for the poisson regression. Since we are using a log link function, the model is estimated as

$$\widehat{\text{Accidents}} &= \hat\beta_0 + \hat{\beta}_B x_B + \hat{\beta}_C x_C + \hat{\beta}_D x_D + \hat{\beta}_E x_E + \hat{\beta}_\text{75-79} x_\text{75-79} + \hat{\beta}_\text{service} x_\text{service}$$ $$= 1.36 + 0.558 x_B - 1.21 x_C - 0.846 x_D - 1.114 x_E + 0.498 x_\text{75-79} + 7.55 \times 10^{-5} x_\text{service}$$

where $x_B, \dots, x_E$ are indicator variables representing that a ship is of type B, C, D, or E (with type A as the reference level); $x_\text{75-79}$ is an indicator representing that the ship was in operation during 1975-1979 (with 1967-74 as the reference level); and $x_\text{service}$ is a numerical variable representing the number of years that the ship was in service.

Interpretation:

-   Controlling for operation timeframe and service life, type B ships experienced an estimated 75% more incidents than Type A ships. $\exp(\hat{\beta}_B) = \exp(0.557) = 1.747$, and $100 \times (1.747 - 1) \approx 75$.
-   A ship being in operation for an additional month increases the expected number of incidents by 0.0076%. A ship being in operation for an addition year increases the expected number of incidents by 0.09%, since $\exp(12 * \hat{\beta}_\text{service}) = 1.000906$

```{r}
broom::tidy(poisson_no_constr_no9, exponentiate=TRUE)
```

The residual plots still look good, and now the worst influential point has been removed, and the remaining influential points seem tolerable. The residual plot has a much more even spread than the residual plot for the identity link model.

```{r}
plot(poisson_no_constr_no9)
```

```{r}
# had to supply starting values to get code to run
poisson_ident_no_constr_no9 = glm(incidents ~ .-construction,
                              data=ShipAccidents[rownames(ShipAccidents)!=9,],
                              family=poisson(link='identity'),
                              start = coef(poisson_no_constr),
                              control = glm.control(maxit=50))
summary(poisson_ident_no_constr_no9)
```

Poisson regression with the log link produced lower root mean squared error (RMSE) than the model with the identity link.

```{r}
### LOOCV 

# R program to implement
# Leave one out cross validation
 
# defining training control
# as Leave One Out Cross Validation
train_control <- trainControl(method = "LOOCV")
 
# training the model by assigning sales column
# as target variable and rest other column
# as independent variable
log_loocv <- train(incidents ~ .-construction,
               data=ShipAccidents[rownames(ShipAccidents)!=9,],
               method='glm',
               family=poisson(),
               trControl = train_control)
 
# printing model performance metrics
# along with other details
log_loocv
```

#2

```{r}
## THE GLM ALGORITHM ENCOUNTERS ISSUES SOMETIMES
ident_loocv <- train(incidents ~ .-construction,
               data=ShipAccidents[rownames(ShipAccidents)!=9,],
               method='glm',
               family=poisson('identity'),
               start = coef(poisson_no_constr),
               control = glm.control(epsilon = 1e-4, maxit=100),
               trControl = train_control)
ident_loocv
```

